This page contains advanced instructions for maintaining the system. Regular users will hopefully not need them.

## Terminal access
Terminal access is needed (strongly recommended) for most of the maintenance and debugging operations. If the Orange Box is connected to the WiFi, the terminal can be accessed remotely through `ssh`. Otherwise, a cable connection is needed.

### SSH
For an introduction to SSH, take a look at this [tutorial](https://www.ssh.com/academy/ssh).  
To log in to the Orange Box, use `ssh rock@rockwp<x>.local` (where `<x>` is the ID number of the box) or `ssh rock@<ip_of_orange_box>`. When prompted for a password, enter `rock`.

You can also [use SSH to copy files](https://linuxize.com/post/how-to-use-scp-command-to-securely-transfer-files/?utm_content=cmp-true) to and from the Orange Box. For example, to copy all measurements to your current working directory, use `scp rock@rockwp<x>.local:/home/rock/measurements .` and enter `rock` when prompted for a password.

### ADB
ADB is short for Android Debug Bridge. This functionality has been ported to Linux and can be used to debug the Rock Pi S mini-computer. You will need a USB Type A to USB Type C cable and appropriate drivers. The instructions for installing drivers are available [here](https://wiki.radxa.com/RockpiS/dev/adb).

Make sure that the power button is **turned off** (the safest thing would be to disconnect the powering cable from PCB). Connect the Rock Pi S with a cable to your computer. The terminal can be accessed by running `adb shell`. By default, this will give the root access. To switch to the "regular" user, enter the command `su - rock`.

### Serial
The Orange Box has a connector for debugging using a serial interface. You will need a cable like [this](https://ftdichip.com/products/ttl-232r-3v3/) and appropriate drivers. When connecting to the debugging connector, leave the positive power supply wire (red, 3V3) of the cable **unconnected**.

Serial communication can be established with a program such as Putty. Follow [this guide](https://wiki.radxa.com/RockpiS/dev/serial-console) for more details.

## Changing WiFi connection
Terminal access is needed to change the WiFi connection.
1. Connect using any of the methods above.
1. Delete the successful connection status file: `rm /home/rock/OrangeBox/status/*`.
1. Delete the existing connection: `sudo rm /etc/NetworkManager/system-connections/*`.
1. Ignore any warnings.
1. Reboot and repeat the [3. First setup](../3.-First-setup) process.

## Complete reset of the system
If you want to start over, follow these instructions. **Be careful, this will also delete all logs and measurements.**
1. Connect using any of the methods above.
1. Run `bash /home/rock/OrangeBox/scripts/clean_up.sh`.
1. Reboot and repeat the [3. First setup](../3.-First-setup) process.

## Autorun
Orange Box is set up to automatically start when it's powered on. This is achieved with [`startup.sh`](../../blob/main/scripts/startup.sh) script. The script calls some other scripts to do the following:
1. Try to connect to the WiFi.
1. Get the latest stable version of the code from the Internet.
1. Run a `tmuxinator` session that starts 3 Blue box interfaces, power measuring, and the script for receiving commands from the user_app.

`startup.sh` script is automatically started after boot using a `systemd` service located in [`OrangeBox.service`](../../blob/main/autorun/OrangeBox.service). This file is copied to `/etc/systemd/system/` before the Orange Box is packaged for shipping.

The tmuxinator session sets up the measuring frequency and the folder where measurements are stored using environment variables. The simplest way they can be set up is in the `/home/rock/.bashrc` file like this:
```bash
export MEAS_INT=10000
export MEAS_DIR="/home/rock/measurements"
```
This must be set up in order for scripts to work properly.


### Configuring the service
To enable the service run: `sudo systemctl enable OrangeBox.service`  
To disable the service run: `sudo systemctl disable OrangeBox.service`  
To see the status of the service run: `sudo systemctl status OrangeBox.service`  
To see the detailed output run: `sudo journalctl -f -u OrangeBox.service` (f is for 'follow', u is for 'unit')

### Disable automatic update / Update manually
To disable automatic updates, add the following line to the `/home/rock/.bashrc`:
```bash
export DISABLE_UPDATE=1
```
To enable it again, set the value to 0 or remove the line.

To manually update the system, run `bash /home/rock/OrangeBox/scripts/update_drivers.sh` on the Rock Pi.

## Additional info
### Tools
The Orange Box Linux system comes preinstalled with some very useful tools.

**Tmuxinator** is a tool that allows you to start a tmux session with a complex layout and automatically run commands by configuring a simple yaml configuration file. Tmux is a terminal multiplexer - it can run multiple terminal windows inside a single window, also in the background. 
You can move between terminal panes by holding down `Ctrl` key and navigating with arrow keys. Switching between tabs is done with `Shift` and arrow keys. If you have a lot of open panes and tabs in your tmux, you can simply kill everything and exit by pressing `Ctrl+a` and then `k`. Exiting the tmux session without killing anything is done by pressing `Ctrl+a` and then `d`. Attaching to an existing tmux session from the terminal can be done with `tmux a`.  
Here are some useful links: [Tmuxinator](https://github.com/tmuxinator/tmuxinator), [Getting starded with Tmux](https://linuxize.com/post/getting-started-with-tmux/), [Tmux Cheat Sheet](https://tmuxcheatsheet.com/)  
Install it with `sudo apt install tmux tmuxinator`.

**Ranger** is a command-line file browser for Linux. You can start ranger with the command `ra`. Moving up and down the folders is done with arrow keys and you can exit with a `q`. When you exit, the working directory in your terminal will be set to the last directory you opened while in Ranger.
Install it with `sudo apt install ranger`.

**Htop** is a better version of `top` - command line interface task manager. Start it with the command `htop` and exit with `q`.
Install it with `sudo apt install htop`.

**Gitman** is an automated system for managing multiple Git repositories intended to replace and improve Git submodules. In our case, it is used to maintain the correct version of [mu_interface](https://github.com/trabbel/mu_interface), [BLE_Sink](https://github.com/WatchPlant/BLE_Sink), and [Zigbee_Sink](https://github.com/WatchPlant/Zigbee_Sink).  
More info can be found on the [official documentation site](https://gitman.readthedocs.io/en/latest/).  
Install it with `python3 -m pip install gitman`.

**Custom configuration files** for these tools are located in the [advanced](../tree/main/advanced) directory and can be copied to their correct locations using the [copy_config.sh](../blob/main/advanced/copy_config.sh) script.

### Rock Pi S
If it is not clear by now, the Orange Box is powered by a Rock Pi S Linux mini-computer (also known as Single-Board-Computer, SBC). Detailed information about it are available on this [wiki](https://wiki.radxa.com/RockpiS).